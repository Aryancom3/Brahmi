// ===============================================
// PHASE 1.2: INITIALIZATION & SETUP
// ===============================================
let DICT = {};
let EXCEPTIONS = {};
let HISTORY = [];

// DOM Element Selectors
const $ = (q) => document.querySelector(q);
const inputText = $('#input-textarea');
const outDiv = $('#output-brahmi');
const ipaDiv = $('#ipa-helper');
const meaningDiv = $('#meaning-output');
const detectedDiv = $('#detected-language');
const statsDiv = $('#char-stats');
const suggestionsDiv = $('#suggestions-container');
const accuracyBar = $('#accuracyBar');
const devanagariTab = $('#tab-devanagari');
const romanTab = $('#tab-roman');
const themeToggleBtn = $('#theme-toggle');
const pdfExportBtn = $('#export-pdf');
const pngExportBtn = $('#export-png');
const historyModal = $('#history-modal'); // Changed from sidebar
const historyOpenBtn = $('#history-open-btn');
const historyCloseBtn = $('#history-close-btn');
const historyList = $('#history-list');
const historyClearBtn = $('#history-clear-btn');

let mode = 'roman';

// Initial Load Function
document.addEventListener('DOMContentLoaded', async () => {
    // Load data files
    try {
        const r = await fetch('dictionary.json', { cache: 'no-store' });
        DICT = await r.json();
        console.log('Dictionary loaded:', Object.keys(DICT).length, 'entries');
    } catch (e) { console.warn('dictionary.json not found.', e); }
    try {
        const r = await fetch('exceptions.json', { cache: 'no-store' });
        EXCEPTIONS = await r.json();
        console.log('Exceptions loaded:', Object.keys(EXCEPTIONS).length, 'entries');
    } catch (e) { console.info('exceptions.json not found (optional).'); }

    // Initialize features
    initTheme();
    initHistory();
    initEventListeners();
    
    // *** NEW: Render all Lucide icons on the page ***
    lucide.createIcons();
    
    // Initial transliteration
    update();
});

// ===============================================
// FEATURE: THEME TOGGLE (DARK/LIGHT MODE)
// ===============================================
function initTheme() {
    const savedTheme = localStorage.getItem('theme') || 'dark';
    if (savedTheme === 'light') {
        document.body.classList.add('light-theme');
    }
}

function toggleTheme() {
    document.body.classList.toggle('light-theme');
    const currentTheme = document.body.classList.contains('light-theme') ? 'light' : 'dark';
    localStorage.setItem('theme', currentTheme);
}

// ===============================================
// FEATURE: INPUT HISTORY (NOW AS A MODAL)
// ===============================================
function initHistory() {
    const savedHistory = localStorage.getItem('brahmiHistory');
    HISTORY = savedHistory ? JSON.parse(savedHistory) : [];
    renderHistory();
}

function addToHistory(text) {
    if (!text || HISTORY.includes(text)) return;
    HISTORY.unshift(text);
    if (HISTORY.length > 20) HISTORY.pop();
    localStorage.setItem('brahmiHistory', JSON.stringify(HISTORY));
    renderHistory();
}

function renderHistory() {
    historyList.innerHTML = '';
    if (HISTORY.length === 0) {
        historyList.innerHTML = '<p class="history-empty">No history yet.</p>';
        return;
    }
    HISTORY.forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.textContent = item;
        div.onclick = () => {
            inputText.value = item;
            update();
            closeHistoryModal();
        };
        historyList.appendChild(div);
    });
}

function clearHistory() {
    HISTORY = [];
    localStorage.removeItem('brahmiHistory');
    renderHistory();
}

function openHistoryModal() {
    historyModal.classList.add('open');
}

function closeHistoryModal() {
    historyModal.classList.remove('open');
}

// ===============================================
// FEATURE: HIGH-QUALITY EXPORTS (PDF & PNG)
// ===============================================
async function exportAsPNG() {
    if (!outDiv.textContent) { toast('Nothing to export.'); return; }
    try {
        toast('Generating PNG...');
        const canvas = await html2canvas(outDiv, {
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--input-bg-color'),
            scale: 2
        });
        const link = document.createElement('a');
        link.download = 'brahmi-export.png';
        link.href = canvas.toDataURL('image/png');
        link.click();
    } catch (e) {
        console.error('PNG export failed:', e);
        toast('Error exporting PNG.');
    }
}

async function exportAsPDF() {
    if (!outDiv.textContent) { toast('Nothing to export.'); return; }
    if (typeof window.jspdf === 'undefined') { toast('PDF library not found.'); return; }
    
    toast('Generating PDF...');
    try {
        const canvas = await html2canvas(outDiv, {
            backgroundColor: getComputedStyle(document.body).getPropertyValue('--input-bg-color'),
            scale: 3
        });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'p',
            unit: 'px',
            format: [canvas.width, canvas.height]
        });
        pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
        pdf.save('brahmi-export.pdf');
    } catch (e) {
        console.error('PDF export failed:', e);
        toast('Error exporting PDF.');
    }
}


// ===============================================
// EVENT LISTENERS
// ===============================================
function initEventListeners() {
    inputText.addEventListener('input', update);
    themeToggleBtn.addEventListener('click', toggleTheme);
    pdfExportBtn.addEventListener('click', exportAsPDF);
    pngExportBtn.addEventListener('click', exportAsPNG);
    historyOpenBtn.addEventListener('click', openHistoryModal);
    historyCloseBtn.addEventListener('click', closeHistoryModal);
    historyClearBtn.addEventListener('click', clearHistory);
    devanagariTab.addEventListener('click', () => switchMode('devanagari'));
    romanTab.addEventListener('click', () => switchMode('roman'));
    $('#copy-output').addEventListener('click', copyOutput);
}

// ===============================================
// CORE LOGIC (Transliteration, Update Loop, etc.)
// ===============================================
const VIRAMA = 'ëÅÜ'; const ANUSVARA = 'ëÄÅ'; const VISARGA = 'ëÄÇ'; const IV = {'a':'ëÄÖ','ƒÅ':'ëÄÜ','i':'ëÄá','ƒ´':'ëÄà','u':'ëÄâ','≈´':'ëÄä','·πõ':'ëÄã','·πù':'ëÄå','·∏∑':'ëÄç','e':'ëÄè','ai':'ëÄê','o':'ëÄë','au':'ëÄí'}; const MV = {'a':'','ƒÅ':'ëÄ∏','i':'ëÄ∫','ƒ´':'ëÄª','u':'ëÄº','≈´':'ëÄΩ','·πõ':'ëÄæ','·πù':'ëÄø','·∏∑':'ëÅÄ','e':'ëÅÅ','ai':'ëÅÇ','o':'ëÅÉ','au':'ëÅÑ'}; const C = {'k':'ëÄì','kh':'ëÄî','g':'ëÄï','gh':'ëÄñ','·πÖ':'ëÄó','c':'ëÄò','ch':'ëÄô','j':'ëÄö','jh':'ëÄõ','√±':'ëÄú','·π≠':'ëÄù','·π≠h':'ëÄû','·∏ç':'ëÄü','·∏çh':'ëÄ†','·πá':'ëÄ°','t':'ëÄ¢','th':'ëÄ£','d':'ëÄ§','dh':'ëÄ•','n':'ëÄ¶','p':'ëÄß','ph':'ëÄ®','b':'ëÄ©','bh':'ëÄ™','m':'ëÄ´','y':'ëÄ¨','r':'ëÄ≠','l':'ëÄÆ','v':'ëÄØ','≈õ':'ëÄ∞','·π£':'ëÄ±','s':'ëÄ≤','h':'ëÄ≥','·∏∑':'ëÄ∑'}; const DEV2BR = {'‡§Ö':'ëÄÖ','‡§Ü':'ëÄÜ','‡§á':'ëÄá','‡§à':'ëÄà','‡§â':'ëÄâ','‡§ä':'ëÄä','‡§ã':'ëÄã','‡•†':'ëÄå','‡§å':'ëÄç','‡§è':'ëÄè','‡§ê':'ëÄê','‡§ì':'ëÄë','‡§î':'ëÄí','‡§æ':'ëÄ∏','‡§ø':'ëÄ∫','‡•Ä':'ëÄª','‡•Å':'ëÄº','‡•Ç':'ëÄΩ','‡•É':'ëÄæ','‡•Ñ':'ëÄø','‡•¢':'ëÅÄ','‡•á':'ëÅÅ','‡•à':'ëÅÇ','‡•ã':'ëÅÉ','‡•å':'ëÅÑ','‡§ï':'ëÄì','‡§ñ':'ëÄî','‡§ó':'ëÄï','‡§ò':'ëÄñ','‡§ô':'ëÄó','‡§ö':'ëÄò','‡§õ':'ëÄô','‡§ú':'ëÄö','‡§ù':'ëÄõ','‡§û':'ëÄú','‡§ü':'ëÄù','‡§†':'ëÄû','‡§°':'ëÄü','‡§¢':'ëÄ†','‡§£':'ëÄ°','‡§§':'ëÄ¢','‡§•':'ëÄ£','‡§¶':'ëÄ§','‡§ß':'ëÄ•','‡§®':'ëÄ¶','‡§™':'ëÄß','‡§´':'ëÄ®','‡§¨':'ëÄ©','‡§≠':'ëÄ™','‡§Æ':'ëÄ´','‡§Ø':'ëÄ¨','‡§∞':'ëÄ≠','‡§≤':'ëÄÆ','‡§µ':'ëÄØ','‡§∂':'ëÄ∞','‡§∑':'ëÄ±','‡§∏':'ëÄ≤','‡§π':'ëÄ≥','‡§Ç':ANUSVARA,'‡§É':VISARGA,'‡•ç':VIRAMA};
const ALL_VOWELS = Object.keys(IV).sort((a, b) => b.length - a.length); const ALL_CONSONANTS = Object.keys(C).sort((a, b) => b.length - a.length);
function romanToBrahmiWord(word) { if (!word) return ""; const lowerWord = word.toLowerCase(); if (EXCEPTIONS[lowerWord]) { return EXCEPTIONS[lowerWord]; } if (lowerWord.endsWith('m')) { return romanToBrahmi(word.slice(0, -1)) + ANUSVARA; } let processedWord = lowerWord; if (processedWord.length > 2 && processedWord.endsWith('a') && C[processedWord[processedWord.length - 2]]) { processedWord = processedWord.slice(0, -1); } let result = ''; let i = 0; while (i < processedWord.length) { let consumed = false; const vowelMatch = ALL_VOWELS.find(v => processedWord.startsWith(v, i)); if (vowelMatch) { result += IV[vowelMatch]; i += vowelMatch.length; consumed = true; } else { const consonantMatch = ALL_CONSONANTS.find(c => processedWord.startsWith(c, i)); if (consonantMatch) { result += C[consonantMatch]; i += consonantMatch.length; const matraMatch = ALL_VOWELS.find(v => processedWord.startsWith(v, i)); if (matraMatch) { result += MV[matraMatch]; i += matraMatch.length; } else { result += VIRAMA; } consumed = true; } } if (!consumed) { result += processedWord[i]; i++; } } if (result.endsWith(VIRAMA)) { result = result.slice(0, -1); } return result; }
const isWord = (s) => /^[\p{L}\p{M}]+$/u.test(s); function splitTokens(text){ return text.match(/\p{L}[\p{L}\p{M}\.]*|\d+|[^\s\p{L}\p{N}]+|\s+/gu) || []; }
function romanToBrahmi(text) { text = text.replace(/·πÉ/g, '·πÅ').replace(/·∏•/g, ':'); return splitTokens(text.normalize('NFC')).map(token => { if (token === '·πÅ') return ANUSVARA; if (token === ':') return VISARGA; return isWord(token) ? romanToBrahmiWord(token) : token; }).join(''); }
function devaToBrahmi(text){ let out=''; for(const ch of text.normalize('NFC')) out+=(DEV2BR[ch]??ch); return out; } const isDeva = (s) => /[\u0900-\u097F]/.test(s);

function update() { const src = inputText.value; const dev = isDeva(src); detectedDiv.textContent = dev ? 'Devanagari' : 'Roman'; const bra = dev ? devaToBrahmi(src) : romanToBrahmi(src); outDiv.textContent = bra; statsDiv.textContent = `${bra.length} chars`; const tokens = splitTokens(src.trim()); const last = (tokens.length ? tokens[tokens.length - 1] : '').replace(/[^\p{L}\p{M}]/gu, ''); if (last) { const direct = DICT[last] ?? DICT[last.toLowerCase()]; meaningDiv.textContent = direct ? direct : '‚Äî'; updateSuggestions(last); } else { meaningDiv.textContent = '‚Äî'; if (suggestionsDiv) suggestionsDiv.innerHTML = ''; } ipaDiv.textContent = dev ? '‚Äî' : (src || '‚Äî'); renderAccuracy(computeAccuracy(src)); }
function switchMode(m) { mode = m; [devanagariTab, romanTab].forEach(tab => tab.classList.remove('active')); if (m === 'devanagari') { devanagariTab.classList.add('active'); inputText.placeholder = "‡§¶‡•á‡§µ‡§®‡§æ‡§ó‡§∞‡•Ä ‡§Æ‡•á‡§Ç ‡§ü‡§æ‡§á‡§™ ‡§ï‡§∞‡•á‡§Ç..."; } else { romanTab.classList.add('active'); inputText.placeholder = "Type Roman (e.g., dharma)..."; } update(); }
function copyOutput() { if (!outDiv.textContent) return; const textarea = document.createElement('textarea'); textarea.value = outDiv.textContent; document.body.appendChild(textarea); textarea.select(); document.execCommand('copy'); document.body.removeChild(textarea); toast('Brahmi output copied'); }
function toast(msg) { const t = document.createElement('div'); t.textContent = msg; t.style.cssText = `position: fixed; left: 50%; bottom: 2rem; transform: translateX(-50%); background-color: var(--input-bg-color); color: var(--text-primary); padding: 0.75rem 1.25rem; border-radius: 8px; border: 1px solid var(--panel-border-color); font-weight: 500; box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37); z-index: 1000; opacity: 0; transition: all 0.3s ease;`; document.body.appendChild(t); setTimeout(() => { t.style.opacity = 1; t.style.bottom = '2.5rem'; }, 30); setTimeout(() => { t.style.opacity = 0; t.style.bottom = '2rem'; setTimeout(() => t.remove(), 300); }, 2000); }
function updateSuggestions(lastWord) { if (!suggestionsDiv) return; suggestionsDiv.innerHTML = ''; if (!lastWord) return; const low = lastWord.toLowerCase(); let count = 0; for (const k of Object.keys(DICT)) { if (k.toLowerCase().startsWith(low)) { const chip = document.createElement('span'); chip.className = 'suggestion-chip'; chip.textContent = k; chip.onclick = () => { inputText.value = inputText.value.replace(/(\p{L}[\p{L}\p{M}\.]*$)/u, k + ' '); inputText.focus(); update(); }; suggestionsDiv.appendChild(chip); if (++count >= 15) break; } } }
function computeAccuracy(src) { if (!src) return 0; const tokens = splitTokens(src).filter(isWord); if (tokens.length === 0) return 0; let hits = 0; for (const t of tokens) { if (DICT[t.toLowerCase()]) hits++; } return Math.min(100, Math.round((hits / tokens.length) * 90 + 10)); }
function renderAccuracy(val) { if (!accuracyBar) return; accuracyBar.textContent = `Roman/Devanagari ‚Üí Brahmi ‚Ä¢ High Accuracy Engine`; }

let timeout;
inputText.addEventListener('input', () => {
    clearTimeout(timeout);
    timeout = setTimeout(() => {
        update();
    }, 150);
});

inputText.addEventListener('blur', () => {
    update();
    addToHistory(inputText.value.trim());
});
